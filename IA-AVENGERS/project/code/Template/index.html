<html>
	<head>
		<title>Réservation de vols</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<meta charset="utf-8"/>
	</head>
	<body>
		<div id="login" class="mt-3 align-middle text-center">
			<input type="email" class="ml-auto mr-auto form-control col-3" id="emailLogin" placeholder="exemple@domaine.xyz" required>
			<br>
			<button type="button" class=" btn btn-primary" id="loginButton">Se connecter</button>
		</div>
		<div id="search" class="d-none">
			<button type="button" class="btn btn-success float-right mt-2 mr-2" id="changeAccount">Changer de compte</button><br>
			<div class="row mt-5">
				<div class="col-7" id="flightsList">
					<h3 class="text-center">Voici les vols disponibles</h3>
					<input class="form-control mt-2 mb-2 col-4 mr-auto ml-auto" type="text" id="searchBar" placeholder="Recherchez un vol ...">
					<table class="table">
  						<thead>
    						<tr>
      							<th scope="col">ID</th>
      							<th scope="col">Départ</th>
      							<th scope="col">Arrivée</th>
      							<th scope="col">Prix (€)</th>
      							<th scope="col">Réservation</th>
    						</tr>
  						</thead>
  						<tbody id="flightsTable">
  						</tbody>
					</table>
				</div>
				<div class="col-5" id="orderList">
					<h3 class="text-center mt-5">Voici vos réservations</h3>
					<table class="table">
  						<thead>
    						<tr>
      							<th scope="col">Départ</th>
      							<th scope="col">Arrivée</th>
      							<th scope="col">Siège</th>
      							<th scope="col">Annulation</th>
    						</tr>
  						</thead>
  						<tbody id="ordersTable">
  						</tbody>
					</table>
				</div>
			</div>
		</div>
	</body>
	<script>
		$(document).ready( function(){

			var email = "";
			var logged = false;
			var cancel_index = [];

			function cancelFlight(email, orderID){
				console.log(arguments[1]);
				$.ajax({
					url: "http://127.0.0.1:5000/api/"+arguments[0]+"/cancel?orderID="+arguments[1],
					type: "DELETE",
					success: function (result) {
						console.log(result);
						usersFlights(email);
					},
					error: function (error) {
						console.log(error);
					}
				})
			}

			function usersFlights(email){
				$.ajax({
					url: "http://127.0.0.1:5000/api/"+arguments[0]+"/orders",
					type: "GET",
					success: function (result) {
						$("#ordersTable").empty();
						var orderList = jQuery.parseJSON(JSON.stringify(result));
						var orderContainer = document.getElementById("ordersTable");
						cancel_index = [];
						var label;
						if(orderList.length > 0){
							for (var i = 0; i < orderList.length; i++) {
								var div2 = document.createElement("tr");
								div2.innerHTML = '<td>'+orderList[i].departureID+'<br>'+orderList[i].departure_time+'</td><td>'+orderList[i].arrivalID+'<br>'+orderList[i].arrival_time+'</td><td>'+orderList[i].seatID+'</td><td><button type="button" class="btn btn-danger" id="c'+orderList[i].orderID+'">Annuler</button></td>';
								label = "c"+orderList[i].orderID;
								cancel_index.push(label);
								console.log(cancel_index);
								orderContainer.appendChild(div2);
								document.getElementById("c"+orderList[i].orderID).onclick = function () {
									theIndex = parseInt(this.id.substring(1),10);
									cancelFlight(email, theIndex);
								}
							}
						}
					},
					error: function (error) {
						console.log(error);
					}
				})
			}

			function orderFlight(email, flightID){
				$.ajax({
					url: "http://127.0.0.1:5000/api/"+arguments[0]+"/orders?flightID="+arguments[1],
					type: "POST",
					success: function (result) {
						console.log(result);
						usersFlights(email);
					},
					error: function (error) {
						console.log(error);
					}
				})
			}

			function getFlights(){
				$.ajax({
					url: "http://127.0.0.1:5000/api/flights/all",
					type: "GET",
					success: function (result) {
						$("#flightsTable").empty();
						var flightList = jQuery.parseJSON(JSON.stringify(result));
						var flightContainer = document.getElementById("flightsTable");
						for (var i = 0; i < flightList.length; i++) {
							var div = document.createElement("tr");
							div.innerHTML = '<td>'+flightList[i].flightID+'</td><td>'+flightList[i].departureID+'<br>'+flightList[i].departure_time+'</td><td>'+flightList[i].arrivalID+'<br>'+flightList[i].arrival_time+'</td><td>'+flightList[i].price+'</td><td><button type="button" class="btn btn-warning" id="'+i+'">Réserver</button></td>';
							flightContainer.appendChild(div);
							document.getElementById(i).onclick = function () {
								orderFlight(email, this.id);
							}
						}
					},
					error: function (error) {
						console.log(error);
					}
				})
			}

			$("#searchBar").keyup(function() { // Quand l'utilisateur utilise la barre de recherche
	          var typedText = $(this).val().toLowerCase(); //On récuère ce que l'utilisateur a tapé
	          $("#flightsTable tr").filter(function() { // On filtre sur la table
	            // Affiche uniquement les résultats correspondants à la recherche
	            $(this).toggle(($(this).children(":eq(1)").text().toLowerCase().indexOf(typedText) > -1) || ($(this).children(":eq(2)").text().toLowerCase().indexOf(typedText) > -1) || ($(this).children(":eq(3)").text().toLowerCase().indexOf(typedText) > -1) || ($(this).children(":eq(4)").text().toLowerCase().indexOf(typedText) > -1));
	          });
	        });

			$("#loginButton").click( function(){
				var email_by_id = document.getElementById('emailLogin');
				if(email_by_id.checkValidity()){
					email = document.getElementById('emailLogin').value;
					logged = true;
					$("#login").addClass("d-none");
					$("#search").removeClass("d-none");
					getFlights();
					usersFlights(email);
				}else{
					console.log("Email invalide");
				}
			});

			$("#changeAccount").click( function(){
				$("#login").removeClass("d-none");
				$("#search").addClass("d-none");
			});
		})
	</script>
</html>